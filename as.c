typedef unsigned char C,*S;typedef char G;typedef short H;typedef int I;typedef long J;
J swap(J*x,J*y){J t=*x;*x=*y;*y=t;return t;}
enum{rax,rcx,rdx,rbx,rsp,rbp,rsi,rdi,
      r8, r9,r10,r11,r12,r13,r14,r15};
enum{syscall,ret,mov,add,sub,imul,cqo,idiv,nop};
enum{rr=1,  //reg reg mode
     mr=2,  //mem reg
     rm=4,  //reg mem
     ri=8}; //reg immediate

#define C(x,y) case x:{y;break;}
J as(G*b,J o,J d,J s,J m)
{G*a=b;
 G rex(G w){return 0x48|w*8|(s>7)*4|d>7;}
 G modrm(){return (0||m&1)*0xC0|(s&7)*8|d&7;}
 G*dir(G p){if(m&2)swap(&s,&d),p+=2;*a++=rex(0),*a++=p,*a++=modrm();}
 switch(o){
 C(syscall,(*a++=0x0F,*a++=0x05))
 C(ret,*a++=0xC3)
 C(add,dir(0x01))
 C(sub,dir(0x29))
 C(mov,(m&8?*a++=0x48+(d>7),*a++=0xb8+d%8,*(J*)a=s,a+=8  //immediate, 
           :dir(0x89)))
 C(cqo, (*a++=0x48,*a++=0x99))
 case imul:case idiv:s=o==imul?5:7,*a++=rex(1),*a++=0xF7,*a++=modrm();break;
 default:*(I*)0;
 }
 return a-b;
}

#include<stdio.h>
#include<stdlib.h>
int test()
{C b[99]={0};
 FILE*f=fopen("o","w");
 I i=0;
 i+=as(b+i,mov,rax,r8,rr);
 i+=as(b+i,mov,rax,r8,mr);
 i+=as(b+i,mov,rax,r8,rm);
 i+=as(b+i,mov,rax,-1,ri);
 i+=as(b+i,mov,r8, -1,ri);
 i+=as(b+i,imul,r8,0,rr);
 i+=as(b+i,idiv,r8,0,rr);
 i+=as(b+i,ret,0,0,0);
 fwrite(b,i,1,f);
 fclose(f);
 return system("objdump -Mintel -b binary -D -m i386:x86-64 o");
}
C*bs(C**c,J o,J d,J s,J m) { return *c+=as(*c,o,d,s,m); }
int elf()
{C b[999]={  /*J org=0x400000;*/
  0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x3e, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x78, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x38, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 96*/ 0xee, 0xee, 0xee, 0xee, 0xee, 0xee, 0xee, 0xee, 
  /*104*/ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  /*112*/ 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  /*120*/
 };
 C*a=b+120;
 bs(&a,mov,rax,60,ri);
 bs(&a,mov,rdi,42,ri);
 bs(&a,syscall,0,0,0);
 *(J*)(b+ 96)=*(J*)(b+104)=a-b;
 FILE*f=fopen("elf","w");
 fwrite(b,a-b,1,f);
 fclose(f);
 int s=system("chmod +x elf");s=system("./elf;echo $?");
}

int main()
{test();
 elf();
}
